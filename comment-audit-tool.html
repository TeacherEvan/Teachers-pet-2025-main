<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment Generation Audit Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .data-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-button {
            background: #28a745;
        }
        .test-button:hover {
            background: #1e7e34;
        }
        .clear-button {
            background: #dc3545;
        }
        .clear-button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Comment Generation Audit Tool</h1>
        <p>This tool will help diagnose issues with the comment generation system by checking data flow from form inputs to final comment output.</p>
        
        <div class="section">
            <h3>ğŸ“Š Control Panel</h3>
            <button onclick="runFullAudit()">Run Full Audit</button>
            <button onclick="testCommentGeneration()" class="test-button">Test Comment Generation</button>
            <button onclick="clearAllData()" class="clear-button">Clear All Data</button>
            <button onclick="createTestData()" class="test-button">Create Test Data</button>
        </div>

        <div class="section">
            <h3>ğŸ’¾ LocalStorage Data</h3>
            <div id="localStorageData" class="data-display">Click "Run Full Audit" to check localStorage data...</div>
        </div>

        <div class="section">
            <h3>ğŸ“ Form Elements Status</h3>
            <div id="formElementsStatus" class="data-display">Click "Run Full Audit" to check form elements...</div>
        </div>

        <div class="section">
            <h3>ğŸ”§ Comment Engine Status</h3>
            <div id="commentEngineStatus" class="data-display">Click "Run Full Audit" to check comment engine...</div>
        </div>

        <div class="section">
            <h3>ğŸ¯ Session Data Processing</h3>
            <div id="sessionDataProcessing" class="data-display">Click "Test Comment Generation" to see session data processing...</div>
        </div>

        <div class="section">
            <h3>ğŸ“„ Generated Comments</h3>
            <div id="generatedComments" class="data-display">Click "Test Comment Generation" to see generated comments...</div>
        </div>

        <div class="section">
            <h3>ğŸš¨ Issues Found</h3>
            <div id="issuesFound">No issues detected yet. Run audit to check for problems.</div>
        </div>
    </div>

    <!-- Include the necessary JS files -->
    <script src="assets/js/comment-engine.js"></script>
    <script src="optimized-comment-generator.js"></script>
    <script src="missing-functions.js"></script>

    <script>
        let auditResults = {
            issues: [],
            warnings: [],
            successes: []
        };

        function addIssue(type, message) {
            auditResults[type].push(message);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function runFullAudit() {
            auditResults = { issues: [], warnings: [], successes: [] };
            
            console.log('ğŸ” Starting Full Audit...');
            
            // Check localStorage data
            checkLocalStorageData();
            
            // Check form elements (if on subjects page)
            checkFormElements();
            
            // Check comment engine availability
            checkCommentEngine();
            
            // Display results
            displayAuditResults();
        }

        function checkLocalStorageData() {
            const localStorageDiv = document.getElementById('localStorageData');
            let output = 'LocalStorage Analysis:\n\n';
            
            try {
                const studentData = localStorage.getItem('studentData');
                if (!studentData) {
                    output += 'âŒ No studentData found in localStorage\n';
                    addIssue('issues', 'No student data found in localStorage');
                } else {
                    const parsed = JSON.parse(studentData);
                    output += 'âœ… Student data found:\n' + JSON.stringify(parsed, null, 2) + '\n\n';
                    
                    // Validate student data
                    if (!parsed.studentName || parsed.studentName.trim() === '') {
                        addIssue('issues', 'Student name is missing or empty');
                    } else {
                        addIssue('successes', `Student name found: "${parsed.studentName}"`);
                    }
                    
                    if (!parsed.gender) {
                        addIssue('issues', 'Gender is missing');
                    } else {
                        addIssue('successes', `Gender found: "${parsed.gender}"`);
                    }
                    
                    if (!parsed.overallAttributes) {
                        addIssue('warnings', 'Overall attributes is missing');
                    } else {
                        addIssue('successes', `Overall attributes: ${parsed.overallAttributes}`);
                    }
                }
                
                // Check for selected subjects
                const selectedSubjects = localStorage.getItem('selectedSubjects');
                if (selectedSubjects) {
                    const subjects = JSON.parse(selectedSubjects);
                    output += `Selected Subjects: ${JSON.stringify(subjects, null, 2)}\n\n`;
                    if (subjects.length === 0) {
                        addIssue('warnings', 'No subjects selected');
                    } else {
                        addIssue('successes', `${subjects.length} subjects selected`);
                    }
                } else {
                    output += 'âš ï¸ No selected subjects found\n\n';
                    addIssue('warnings', 'No selected subjects found in localStorage');
                }
                
                // Check for other data
                const allKeys = Object.keys(localStorage);
                output += `All localStorage keys: ${JSON.stringify(allKeys, null, 2)}`;
                
            } catch (error) {
                output += `âŒ Error reading localStorage: ${error.message}`;
                addIssue('issues', `Error reading localStorage: ${error.message}`);
            }
            
            localStorageDiv.textContent = output;
        }

        function checkFormElements() {
            const formDiv = document.getElementById('formElementsStatus');
            let output = 'Form Elements Analysis:\n\n';
            
            // Check if we're on the subjects page
            const subjectCheckboxes = document.querySelectorAll('.subject-checkbox');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (subjectCheckboxes.length > 0) {
                output += `âœ… Found ${subjectCheckboxes.length} subject checkboxes\n`;
                const checkedSubjects = document.querySelectorAll('.subject-checkbox:checked');
                output += `ğŸ“Š Checked subjects: ${checkedSubjects.length}\n`;
                
                if (checkedSubjects.length === 0) {
                    addIssue('warnings', 'No subjects currently checked in form');
                } else {
                    addIssue('successes', `${checkedSubjects.length} subjects checked in form`);
                }
            } else {
                output += 'âš ï¸ Not on subjects page or subject checkboxes not found\n';
                addIssue('warnings', 'Subject checkboxes not found - may not be on subjects page');
            }
            
            if (topicCheckboxes.length > 0) {
                output += `âœ… Found ${topicCheckboxes.length} topic checkboxes\n`;
                const checkedTopics = document.querySelectorAll('.topic-checkbox:checked');
                output += `ğŸ“Š Checked topics: ${checkedTopics.length}\n`;
                
                if (checkedTopics.length === 0) {
                    addIssue('warnings', 'No topics currently checked in form');
                } else {
                    addIssue('successes', `${checkedTopics.length} topics checked in form`);
                }
            }
            
            // Check for comment display elements
            const commentElements = {
                'commentText1': document.getElementById('commentText1'),
                'commentText2': document.getElementById('commentText2'),
                'wordCount1': document.getElementById('wordCount1'),
                'wordCount2': document.getElementById('wordCount2')
            };
            
            output += '\nComment Display Elements:\n';
            for (const [id, element] of Object.entries(commentElements)) {
                if (element) {
                    output += `âœ… ${id}: Found\n`;
                    output += `   Content: "${element.textContent.substring(0, 50)}..."\n`;
                } else {
                    output += `âŒ ${id}: Not found\n`;
                    addIssue('issues', `Comment display element ${id} not found`);
                }
            }
            
            formDiv.textContent = output;
        }

        function checkCommentEngine() {
            const engineDiv = document.getElementById('commentEngineStatus');
            let output = 'Comment Engine Analysis:\n\n';
            
            try {
                // Check if PremiumCommentEngine is available
                if (typeof PremiumCommentEngine !== 'undefined') {
                    output += 'âœ… PremiumCommentEngine class is available\n';
                    
                    try {
                        const engine = new PremiumCommentEngine();
                        output += 'âœ… PremiumCommentEngine instance created successfully\n';
                        addIssue('successes', 'PremiumCommentEngine is working');
                    } catch (error) {
                        output += `âŒ Error creating PremiumCommentEngine: ${error.message}\n`;
                        addIssue('issues', `Error creating PremiumCommentEngine: ${error.message}`);
                    }
                } else {
                    output += 'âŒ PremiumCommentEngine class not found\n';
                    addIssue('issues', 'PremiumCommentEngine class not found');
                }
                
                // Check if OptimizedCommentGenerator is available
                if (typeof OptimizedCommentGenerator !== 'undefined') {
                    output += 'âœ… OptimizedCommentGenerator class is available\n';
                    
                    try {
                        const generator = new OptimizedCommentGenerator();
                        output += 'âœ… OptimizedCommentGenerator instance created successfully\n';
                        addIssue('successes', 'OptimizedCommentGenerator is working');
                    } catch (error) {
                        output += `âŒ Error creating OptimizedCommentGenerator: ${error.message}\n`;
                        addIssue('issues', `Error creating OptimizedCommentGenerator: ${error.message}`);
                    }
                } else {
                    output += 'âŒ OptimizedCommentGenerator class not found\n';
                    addIssue('issues', 'OptimizedCommentGenerator class not found');
                }
                
                // Check if ensureCommentGeneration function is available
                if (typeof ensureCommentGeneration === 'function') {
                    output += 'âœ… ensureCommentGeneration function is available\n';
                    addIssue('successes', 'ensureCommentGeneration function is available');
                } else {
                    output += 'âŒ ensureCommentGeneration function not found\n';
                    addIssue('issues', 'ensureCommentGeneration function not found');
                }
                
            } catch (error) {
                output += `âŒ Error checking comment engine: ${error.message}\n`;
                addIssue('issues', `Error checking comment engine: ${error.message}`);
            }
            
            engineDiv.textContent = output;
        }

        function testCommentGeneration() {
            const sessionDiv = document.getElementById('sessionDataProcessing');
            const commentsDiv = document.getElementById('generatedComments');
            
            console.log('ğŸ§ª Testing Comment Generation...');
            
            try {
                // Get session data using the same method as the actual system
                let sessionData;
                
                if (typeof OptimizedCommentGenerator !== 'undefined') {
                    const generator = new OptimizedCommentGenerator();
                    sessionData = generator.collectSessionData();
                } else {
                    // Fallback manual collection
                    const studentDataStr = localStorage.getItem('studentData');
                    const studentData = studentDataStr ? JSON.parse(studentDataStr) : {};
                    
                    sessionData = {
                        studentName: studentData.studentName || '',
                        gender: studentData.gender || 'they',
                        overallRating: parseInt(studentData.overallAttributes) || 5,
                        strengths: studentData.strengths || '',
                        weaknesses: studentData.weaknesses || '',
                        subjects: [],
                        topicRatings: {}
                    };
                }
                
                sessionDiv.textContent = 'Session Data Collected:\n\n' + JSON.stringify(sessionData, null, 2);
                
                // Validate session data
                if (!sessionData.studentName || sessionData.studentName.trim() === '') {
                    commentsDiv.textContent = 'âŒ Cannot generate comments: Student name is missing';
                    addIssue('issues', 'Comment generation failed: Student name is missing');
                    return;
                }
                
                // Try to generate comments
                if (typeof PremiumCommentEngine !== 'undefined') {
                    const engine = new PremiumCommentEngine();
                    const comments = engine.generateComments(sessionData);
                    
                    commentsDiv.textContent = 'Generated Comments:\n\n' +
                        'MALE TEACHER STYLE:\n' + comments.male + '\n\n' +
                        'FEMALE TEACHER STYLE:\n' + comments.female + '\n\n' +
                        'WORD COUNTS:\n' + JSON.stringify(comments.wordCount, null, 2);
                    
                    addIssue('successes', 'Comments generated successfully');
                } else {
                    commentsDiv.textContent = 'âŒ Cannot generate comments: PremiumCommentEngine not available';
                    addIssue('issues', 'Comment generation failed: PremiumCommentEngine not available');
                }
                
            } catch (error) {
                commentsDiv.textContent = `âŒ Error during comment generation: ${error.message}\n\n${error.stack}`;
                addIssue('issues', `Comment generation error: ${error.message}`);
            }
        }

        function createTestData() {
            const testData = {
                studentName: 'Emma Wilson',
                gender: 'she',
                strengths: 'Creative thinking, helpful to others, excellent listening skills',
                weaknesses: 'Sometimes rushes through work, needs encouragement with math',
                overallAttributes: '7',
                timestamp: Date.now(),
                version: '1.0'
            };
            
            localStorage.setItem('studentData', JSON.stringify(testData));
            
            // Also create some test subject selections
            const testSubjects = ['Mathematics', 'Reading', 'Art'];
            localStorage.setItem('selectedSubjects', JSON.stringify(testSubjects));
            
            alert('Test data created successfully! You can now run audits and tests.');
            runFullAudit();
        }

        function clearAllData() {
            if (confirm('This will clear all localStorage data. Are you sure?')) {
                localStorage.clear();
                alert('All data cleared!');
                runFullAudit();
            }
        }

        function displayAuditResults() {
            const issuesDiv = document.getElementById('issuesFound');
            let output = '';
            
            if (auditResults.issues.length > 0) {
                output += '<div class="error"><strong>ğŸš¨ Critical Issues Found:</strong><ul>';
                auditResults.issues.forEach(issue => {
                    output += `<li>${issue}</li>`;
                });
                output += '</ul></div>';
            }
            
            if (auditResults.warnings.length > 0) {
                output += '<div class="warning"><strong>âš ï¸ Warnings:</strong><ul>';
                auditResults.warnings.forEach(warning => {
                    output += `<li>${warning}</li>`;
                });
                output += '</ul></div>';
            }
            
            if (auditResults.successes.length > 0) {
                output += '<div class="success"><strong>âœ… Working Correctly:</strong><ul>';
                auditResults.successes.forEach(success => {
                    output += `<li>${success}</li>`;
                });
                output += '</ul></div>';
            }
            
            if (auditResults.issues.length === 0 && auditResults.warnings.length === 0) {
                output = '<div class="success">ğŸ‰ No issues found! The comment generation system appears to be working correctly.</div>';
            }
            
            issuesDiv.innerHTML = output;
        }

        // Auto-run audit on page load
        window.addEventListener('load', function() {
            setTimeout(runFullAudit, 1000);
        });
    </script>
</body>
</html>
