<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.Q Isolation Test - Verify I.Q Only Appears When Selected</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }

        .test-case {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-case h3 {
            margin-top: 0;
            color: #2196F3;
        }

        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .comment-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            line-height: 1.6;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background: #45a049;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .summary {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .summary h2 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</head>

<body>
    <h1>üî¨ I.Q Isolation Test</h1>

    <div class="info">
        <strong>Purpose:</strong> Verify that "I.Q" only appears in generated comments when explicitly selected by the
        teacher.
        <br><br>
        <strong>Bug:</strong> I.Q was appearing in comments due to keyword overlap ("shape" keyword appears in both I.Q
        and Physical Education mappings).
        <br><br>
        <strong>Fix:</strong> Modified <code>inferSubjectsFromTopics()</code> to use DOM structure instead of keyword
        matching.
    </div>

    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>

    <div id="results"></div>

    <!-- Engine Modules (Refactored) -->
    <script src="assets/js/engine/utils.js"></script>
    <script src="assets/js/engine/processor.js"></script>
    <script src="assets/js/engine/templates.js"></script>
    <script src="assets/js/engine/core.js"></script>
    <script>
        async function testCase(testName, sessionData, shouldContainIQ) {
            const resultsDiv = document.getElementById('results');
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';

            testDiv.innerHTML = `<h3>Test: ${testName}</h3>`;

            // Display test inputs
            testDiv.innerHTML += `<div><strong>Subjects:</strong> ${sessionData.subjects.join(', ')}</div>`;
            testDiv.innerHTML += `<div><strong>Topics:</strong> ${Object.keys(sessionData.topicRatings).join(', ')}</div>`;

            // Generate comment
            const engine = new EnhancedCommentEngine();
            const comments = await engine.generateComments(sessionData);
            const comment = comments.male || comments.female || '';

            testDiv.innerHTML += `<div class="comment-output"><strong>Generated Comment:</strong><br>${comment}</div>`;

            // Check if I.Q appears in the comment
            const containsIQ = comment.includes('I.Q');
            const passed = containsIQ === shouldContainIQ;

            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;

            if (passed) {
                resultDiv.textContent = `‚úÖ PASS: I.Q ${shouldContainIQ ? 'correctly appeared' : 'correctly did NOT appear'} in comment`;
            } else {
                resultDiv.textContent = `‚ùå FAIL: I.Q ${containsIQ ? 'appeared' : 'did NOT appear'} but ${shouldContainIQ ? 'should have' : 'should NOT have'}`;
            }

            testDiv.appendChild(resultDiv);
            resultsDiv.appendChild(testDiv);

            return passed;
        }

        async function runAllTests() {
            clearResults();
            const results = [];

            // Test 1: I.Q NOT selected, should NOT appear
            results.push(await testCase(
                'Arts + Physical Education (NO I.Q selected)',
                {
                    studentName: 'Jedi',
                    gender: 'male',
                    overallRating: 5,
                    strengths: '',
                    weaknesses: '',
                    subjects: ['Arts', 'Physical Education'],
                    topicRatings: {
                        'ring craft - pig\'s face': 5,
                        'banana stem painting': 5,
                        'finger painting - flower': 5,
                        'trampoline jumping': 5,
                        'hurdle jumping': 5,
                        'balancing game and putting the ball into the rubber ring': 5
                    }
                },
                false // I.Q should NOT appear
            ));

            // Test 2: I.Q explicitly selected, should appear
            results.push(await testCase(
                'I.Q explicitly selected',
                {
                    studentName: 'Sarah',
                    gender: 'female',
                    overallRating: 6,
                    strengths: '',
                    weaknesses: '',
                    subjects: ['I.Q', 'Mathematics'],
                    topicRatings: {
                        'color pictures that are the same': 6,
                        'color pictures that are fatter': 6,
                        'count pictures': 6
                    }
                },
                true // I.Q SHOULD appear
            ));

            // Test 3: Physical Education with "shape" keyword, I.Q NOT selected
            results.push(await testCase(
                'Physical Education with "shape" topic (NO I.Q selected)',
                {
                    studentName: 'Alex',
                    gender: 'male',
                    overallRating: 7,
                    strengths: '',
                    weaknesses: '',
                    subjects: ['Physical Education'],
                    topicRatings: {
                        'jumping by shape': 7,
                        'balancing game': 7
                    }
                },
                false // I.Q should NOT appear even with "shape" keyword
            ));

            // Test 4: English with "same" keyword, I.Q NOT selected
            results.push(await testCase(
                'English with "same" keyword (NO I.Q selected)',
                {
                    studentName: 'Emma',
                    gender: 'female',
                    overallRating: 8,
                    strengths: '',
                    weaknesses: '',
                    subjects: ['English'],
                    topicRatings: {
                        'Draw lines to match the same letters': 8
                    }
                },
                false // I.Q should NOT appear even with "same" keyword
            ));

            // Test 5: Multiple subjects including I.Q
            results.push(await testCase(
                'Multiple subjects including I.Q',
                {
                    studentName: 'Michael',
                    gender: 'male',
                    overallRating: 9,
                    strengths: '',
                    weaknesses: '',
                    subjects: ['English', 'I.Q', 'Arts'],
                    topicRatings: {
                        'trace letters': 9,
                        'color hot and cold items': 9,
                        'finger painting': 9
                    }
                },
                true // I.Q SHOULD appear
            ));

            // Display summary
            const passCount = results.filter(r => r).length;
            const totalCount = results.length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'summary';
            summaryDiv.innerHTML = `
                <h2>üìä Test Summary</h2>
                <div style="font-size: 24px; font-weight: bold;">
                    ${passCount} / ${totalCount} tests passed
                    ${passCount === totalCount ? 'üéâ' : '‚ö†Ô∏è'}
                </div>
                <div style="margin-top: 10px;">
                    ${passCount === totalCount
                    ? '‚úÖ All tests passed! The I.Q false-positive bug is fixed.'
                    : '‚ùå Some tests failed. The bug may not be fully resolved.'}
                </div>
            `;
            document.getElementById('results').insertBefore(summaryDiv, document.getElementById('results').firstChild);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>

</html>